# 故障排除指南

## 常见错误及解决方案

### 1. 导入错误：cannot import name 'ACCOUNT_ID'

**错误信息**:
```
ImportError: cannot import name 'ACCOUNT_ID' from 'config'
```

**原因**: 
项目已移除默认账户配置 `ACCOUNT_ID`，改为按市场类型配置账户。

**解决方案**:
确保使用最新版本的代码。如果问题仍然存在：

```bash
# 重新拉取最新代码
git pull origin main

# 或者手动修复 futu_client.py
# 将导入语句中的 ACCOUNT_ID 移除
```

**正确的导入语句**:
```python
from config import (
    FUTU_COOKIE, FUTU_BASE_URL, FUTU_MATCH_URL,
    MARKET_TYPE, ORDER_SIDE, ORDER_TYPE, SECURITY_TYPE,
    ACCOUNT_MAPPING
)
```

---

### 2. pydantic-core 安装失败

**错误信息**:
```
Cargo, the Rust package manager, is not installed
```

**解决方案**:
参考 [安装指南](./安装指南.md) 中的详细说明。

快速解决：
```bash
pip install pydantic>=2.9.2 --upgrade
```

---

### 3. Cookie 无效或过期

**错误信息**:
```
获取账户信息失败: 401 Unauthorized
```

**原因**: 
Cookie 已过期或无效。

**解决方案**:
1. 重新登录富途网站
2. 获取新的 Cookie
3. 更新 `.env` 文件中的 `FUTU_COOKIE`

**获取 Cookie 步骤**:
1. 访问 https://www.futunn.com/paper-trade
2. 登录账号
3. 按 F12 打开开发者工具
4. 切换到 Network 标签
5. 刷新页面
6. 找到任意请求，复制 Cookie 值
7. 更新 `.env` 文件

---

### 4. 账户ID未配置

**错误信息**:
```
未找到US市场的模拟账户，请在.env文件中配置ACCOUNT_ID_US
```

**原因**: 
未配置对应市场的账户ID。

**解决方案**:
在 `.env` 文件中添加账户配置：

```env
ACCOUNT_ID_US=your_us_account_id
ACCOUNT_ID_HK=your_hk_account_id
ACCOUNT_ID_CN=your_cn_account_id
```

**获取账户ID**:
```python
from futu_client import FutuClient
import asyncio

async def get_accounts():
    client = FutuClient()
    accounts = await client.get_account_list()
    for acc in accounts:
        print(f"{acc['market_type']}: {acc['account_id']}")

asyncio.run(get_accounts())
```

---

### 5. 下单失败：余额不足

**错误信息**:
```
下单失败: 余额不足
```

**解决方案**:
1. 检查账户余额
2. 减少购买数量
3. 降低购买价格

**查询账户余额**:
```python
account = await client.get_account_info(market_type="US")
print(f"可用资金: {account.available_funds}")
```

---

### 6. 下单失败：市场未开盘

**错误信息**:
```
下单失败: 市场未开盘
```

**原因**: 
当前时间不在交易时间内。

**解决方案**:
等待市场开盘后再交易。

**交易时间**:
- **美股**: 
  - 夏令时: 21:30-04:00 (北京时间)
  - 冬令时: 22:30-05:00 (北京时间)
- **港股**: 09:30-12:00, 13:00-16:00 (香港时间)
- **A股**: 09:30-11:30, 13:00-15:00 (北京时间)

---

### 7. 搜索股票失败

**错误信息**:
```
未找到股票: XXXX
```

**原因**: 
股票代码错误或不存在。

**解决方案**:
1. 检查股票代码是否正确
2. 确认股票所属市场
3. 使用正确的市场类型参数

**示例**:
```python
# 美股
stocks = await client.search_stock("AAPL", market_type="US")

# A股
stocks = await client.search_stock("600519", market_type="CN")

# 港股
stocks = await client.search_stock("00700", market_type="HK")
```

---

### 8. 异步函数调用错误

**错误信息**:
```
RuntimeError: This event loop is already running
```

**原因**: 
在已有事件循环中使用 `asyncio.run()`。

**解决方案**:
使用 `await` 而不是 `asyncio.run()`：

```python
# 错误
result = asyncio.run(client.place_order(request))

# 正确
result = await client.place_order(request)
```

如果在 Jupyter Notebook 中：
```python
# 使用 await 直接调用
result = await client.place_order(request)
```

---

### 9. 模块导入错误

**错误信息**:
```
ModuleNotFoundError: No module named 'httpx'
```

**原因**: 
依赖包未安装。

**解决方案**:
```bash
pip install -r requirements.txt
```

---

### 10. 环境变量未加载

**错误信息**:
```
FUTU_COOKIE 为空
```

**原因**: 
`.env` 文件不存在或未正确加载。

**解决方案**:
1. 确保 `.env` 文件存在于项目根目录
2. 检查文件名是否正确（不是 `.env.txt`）
3. 确保文件内容格式正确

**检查方法**:
```python
import os
from dotenv import load_dotenv

load_dotenv()
print(f"Cookie: {os.getenv('FUTU_COOKIE')[:20]}...")
```

---

### 11. 网络连接错误

**错误信息**:
```
httpx.ConnectError: Connection refused
```

**原因**: 
网络连接问题或富途服务器不可达。

**解决方案**:
1. 检查网络连接
2. 确认富途网站是否可访问
3. 检查防火墙设置
4. 尝试使用代理

---

### 12. 数据验证错误

**错误信息**:
```
pydantic.ValidationError: validation error for TradeRequest
```

**原因**: 
请求参数不符合要求。

**解决方案**:
检查参数类型和值：

```python
# 确保参数类型正确
TradeRequest(
    stock_code="AAPL",        # 字符串
    market_type="US",         # 字符串: US/HK/CN
    side="BUY",               # 字符串: BUY/SELL
    order_type="LIMIT",       # 字符串: LIMIT/MARKET
    price=180.0,              # 浮点数
    quantity=10,              # 整数
    security_type="STOCK"     # 字符串: STOCK
)
```

---

## 调试技巧

### 1. 启用详细日志

在代码中添加日志输出：

```python
import logging

logging.basicConfig(level=logging.DEBUG)
```

### 2. 检查响应内容

```python
try:
    result = await client.place_order(request)
except Exception as e:
    print(f"错误类型: {type(e)}")
    print(f"错误信息: {str(e)}")
    import traceback
    traceback.print_exc()
```

### 3. 验证配置

```python
from config import *

print(f"Cookie: {FUTU_COOKIE[:20]}...")
print(f"账户映射: {ACCOUNT_MAPPING}")
print(f"市场类型: {MARKET_TYPE}")
```

### 4. 测试网络连接

```python
import httpx

async def test_connection():
    async with httpx.AsyncClient() as client:
        response = await client.get("https://www.futunn.com")
        print(f"状态码: {response.status_code}")

asyncio.run(test_connection())
```

---

## 获取帮助

如果以上方法都无法解决问题：

1. **查看文档**: 
   - [API接口文档](./API接口文档.md)
   - [使用示例](./使用示例.md)
   - [安装指南](./安装指南.md)

2. **运行测试脚本**:
   ```bash
   python test_place_order.py
   ```

3. **检查 Issues**: 
   查看项目 Issues 是否有类似问题

4. **提交 Issue**: 
   提供详细的错误信息和复现步骤

---

## 常用检查清单

在提交问题前，请检查：

- [ ] Python 版本 >= 3.8
- [ ] 依赖包已正确安装
- [ ] `.env` 文件存在且配置正确
- [ ] Cookie 有效且未过期
- [ ] 账户ID已配置
- [ ] 网络连接正常
- [ ] 市场处于交易时间
- [ ] 账户余额充足
- [ ] 参数类型和值正确

---

**最后更新**: 2025-11-01
