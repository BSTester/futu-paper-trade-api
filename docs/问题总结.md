# é—®é¢˜æ€»ç»“ä¸è§£å†³æ–¹æ¡ˆ

## ğŸ” é—®é¢˜åˆ†æ

é€šè¿‡è¯¦ç»†çš„è°ƒè¯•å’ŒPlaywrightæŠ“åŒ…ï¼Œæˆ‘ä»¬ç¡®è®¤äº†ä»¥ä¸‹äº‹å®ï¼š

### âœ… æ­£ç¡®çš„éƒ¨åˆ†

1. **HTTPæ–¹æ³•**: GET âœ…
   - æ‰€æœ‰æŸ¥è¯¢æ¥å£éƒ½ä½¿ç”¨GETæ–¹æ³•
   - æˆ‘ä»¬çš„ä»£ç ä½¿ç”¨GETæ˜¯æ­£ç¡®çš„

2. **APIç«¯ç‚¹**: âœ…
   - `https://www.futunn.com/paper-trade/common-api`
   - ç«¯ç‚¹åœ°å€æ­£ç¡®

3. **æ–¹æ³•å**: âœ…
   - `getAccountDetail` - æ­£ç¡®
   - `getIntegratedPosList` - æ­£ç¡®
   - `batchGetSecurityQuote` - æ­£ç¡®
   - ä¸æµè§ˆå™¨å®é™…è°ƒç”¨å®Œå…¨ä¸€è‡´

4. **å‚æ•°æ ¼å¼**: âœ…
   - `_m=getAccountDetail`
   - `account_id=16992013`
   - å‚æ•°æ ¼å¼æ­£ç¡®

### âŒ é—®é¢˜æ‰€åœ¨

**å¯Œé€”APIè¿”å›**:
```json
{"code": -1, "message": "Invalid Method", "data": []}
```

**å¯èƒ½çš„åŸå› **:

1. **Cookieæ—¶æ•ˆæ€§**
   - Cookieä¸­çš„æ—¶é—´æˆ³å¯èƒ½å·²è¿‡æœŸ
   - æŸäº›ä¼šè¯ç›¸å…³çš„å­—æ®µå¯èƒ½å¤±æ•ˆ
   - ä¾‹å¦‚: `_ga_*`, `_uetsid`, `_uetvid` ç­‰

2. **è¯·æ±‚å¤´ä¸å®Œæ•´**
   - å¯èƒ½ç¼ºå°‘æŸäº›æµè§ˆå™¨ç‰¹æœ‰çš„è¯·æ±‚å¤´
   - CSRFç›¸å…³çš„éªŒè¯å¯èƒ½éœ€è¦é¢å¤–çš„å¤´

3. **ä¼šè¯çŠ¶æ€**
   - Cookieè™½ç„¶å­˜åœ¨ï¼Œä½†ä¼šè¯å¯èƒ½å·²å¤±æ•ˆ
   - éœ€è¦é‡æ–°ç™»å½•è·å–æ–°çš„ä¼šè¯

---

## ğŸ¯ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: é‡æ–°è·å–Cookieï¼ˆæ¨èå°è¯•ï¼‰

**æ­¥éª¤**:

1. **æ¸…é™¤æ—§Cookie**
   - åœ¨æµè§ˆå™¨ä¸­é€€å‡ºç™»å½•
   - æ¸…é™¤æ‰€æœ‰å¯Œé€”ç›¸å…³çš„Cookie

2. **é‡æ–°ç™»å½•**
   - è®¿é—® https://www.futunn.com/paper-trade
   - é‡æ–°ç™»å½•è´¦æˆ·

3. **è·å–æ–°Cookie**
   - æ‰“å¼€å¼€å‘è€…å·¥å…· (F12)
   - åˆ‡æ¢åˆ° Application/Storage â†’ Cookies
   - é€‰æ‹© `https://www.futunn.com`
   - å¤åˆ¶æ‰€æœ‰Cookie

4. **æ›´æ–°.envæ–‡ä»¶**
   - å°†æ–°Cookieç²˜è´´åˆ° `FUTU_COOKIE`
   - ä¿å­˜æ–‡ä»¶
   - é‡å¯æœåŠ¡

**è·å–Cookieçš„æ­£ç¡®æ–¹å¼**:
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ
document.cookie
```

æˆ–è€…ä½¿ç”¨å¼€å‘è€…å·¥å…·çš„ Network æ ‡ç­¾ï¼š
1. åˆ·æ–°é¡µé¢
2. æ‰¾åˆ°ä»»æ„è¯·æ±‚
3. æŸ¥çœ‹ Request Headers
4. å¤åˆ¶å®Œæ•´çš„ Cookie å€¼

---

### æ–¹æ¡ˆ2: å®Œå–„è¯·æ±‚å¤´

åœ¨ `futu_client.py` ä¸­æ·»åŠ æ›´å¤šè¯·æ±‚å¤´ï¼š

```python
self.headers = {
    "Cookie": self.cookie,
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",
    "Accept": "application/json, text/plain, */*",
    "Accept-Language": "zh-CN,zh;q=0.9,en;q=0.8",
    "Accept-Encoding": "gzip, deflate, br",
    "Referer": "https://www.futunn.com/paper-trade",
    "Origin": "https://www.futunn.com",
    "Sec-Fetch-Dest": "empty",
    "Sec-Fetch-Mode": "cors",
    "Sec-Fetch-Site": "same-origin",
    "Sec-Ch-Ua": '"Not_A Brand";v="8", "Chromium";v="120"',
    "Sec-Ch-Ua-Mobile": "?0",
    "Sec-Ch-Ua-Platform": '"Windows"',
    "X-Requested-With": "XMLHttpRequest",
    "Cache-Control": "no-cache",
    "Pragma": "no-cache"
}
```

---

### æ–¹æ¡ˆ3: ä½¿ç”¨å¯Œé€”OpenD APIï¼ˆé•¿æœŸæ–¹æ¡ˆï¼‰

**ä¼˜ç‚¹**:
- å®˜æ–¹æ”¯æŒï¼Œç¨³å®šå¯é 
- ä¸ä¾èµ–Cookieå’Œæµè§ˆå™¨
- æ–‡æ¡£å®Œå–„
- åŠŸèƒ½å®Œæ•´

**å®‰è£…**:
```bash
pip install futu-api
```

**ç¤ºä¾‹ä»£ç **:
```python
from futu import OpenQuoteContext, OpenSecTradeContext

# è¡Œæƒ…ä¸Šä¸‹æ–‡
quote_ctx = OpenQuoteContext(host='127.0.0.1', port=11111)

# è·å–è‚¡ç¥¨è¡Œæƒ…
ret, data = quote_ctx.get_market_snapshot(['US.AAPL'])
if ret == 0:
    print(data)

# äº¤æ˜“ä¸Šä¸‹æ–‡
trade_ctx = OpenSecTradeContext(filter_trdmarket=TrdMarket.US, host='127.0.0.1', port=11111)

# è·å–è´¦æˆ·ä¿¡æ¯
ret, data = trade_ctx.accinfo_query()
if ret == 0:
    print(data)
```

**å‚è€ƒ**:
- å®˜æ–¹æ–‡æ¡£: https://openapi.futunn.com/
- GitHub: https://github.com/FutunnOpen/py-futu-api

---

### æ–¹æ¡ˆ4: ä½¿ç”¨Playwrightè‡ªåŠ¨åŒ–

ç›´æ¥ä½¿ç”¨Playwrightæ¥æ‰§è¡Œæ“ä½œï¼š

```python
from playwright.async_api import async_playwright

async def get_account_info():
    async with async_playwright() as p:
        browser = await p.chromium.launch(headless=False)
        context = await browser.new_context()
        
        # åŠ è½½Cookie
        await context.add_cookies([
            {"name": "uid", "value": "255983", "domain": ".futunn.com", "path": "/"},
            # ... å…¶ä»–Cookie
        ])
        
        page = await context.new_page()
        
        # ç›‘å¬APIå“åº”
        async def handle_response(response):
            if "getAccountDetail" in response.url:
                data = await response.json()
                print(f"è´¦æˆ·ä¿¡æ¯: {data}")
        
        page.on("response", handle_response)
        
        # è®¿é—®é¡µé¢
        await page.goto("https://www.futunn.com/paper-trade")
        await page.wait_for_timeout(5000)
        
        await browser.close()
```

---

## ğŸ“Š å½“å‰çŠ¶æ€

| é¡¹ç›® | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| HTTPæ–¹æ³• | âœ… æ­£ç¡® | GETæ–¹æ³• |
| APIç«¯ç‚¹ | âœ… æ­£ç¡® | common-api |
| æ–¹æ³•å | âœ… æ­£ç¡® | ä¸æµè§ˆå™¨ä¸€è‡´ |
| å‚æ•°æ ¼å¼ | âœ… æ­£ç¡® | æ ¼å¼æ­£ç¡® |
| Cookie | âš ï¸ å¯èƒ½è¿‡æœŸ | éœ€è¦æ›´æ–° |
| è¯·æ±‚å¤´ | âš ï¸ å¯èƒ½ä¸å®Œæ•´ | éœ€è¦å®Œå–„ |

---

## ğŸ”§ ç«‹å³è¡ŒåŠ¨

### ä¼˜å…ˆçº§1: æ›´æ–°Cookie

1. åœ¨æµè§ˆå™¨ä¸­é‡æ–°ç™»å½•å¯Œé€”
2. è·å–æœ€æ–°çš„Cookie
3. æ›´æ–° `.env` æ–‡ä»¶
4. é‡å¯æœåŠ¡æµ‹è¯•

### ä¼˜å…ˆçº§2: å®Œå–„è¯·æ±‚å¤´

å¦‚æœæ›´æ–°Cookieåä»æœ‰é—®é¢˜ï¼š
1. å¯¹æ¯”æµè§ˆå™¨çš„è¯·æ±‚å¤´
2. æ·»åŠ ç¼ºå¤±çš„è¯·æ±‚å¤´
3. é‡æ–°æµ‹è¯•

### ä¼˜å…ˆçº§3: è€ƒè™‘OpenD API

å¦‚æœWeb APIæŒç»­æœ‰é—®é¢˜ï¼š
1. å®‰è£…OpenDå®¢æˆ·ç«¯
2. å®‰è£…futu-apiåŒ…
3. é‡æ„ä»£ç ä½¿ç”¨OpenD API

---

## ğŸ’¡ æµ‹è¯•æ–¹æ³•

### 1. ä½¿ç”¨curlæµ‹è¯•

```bash
curl -H "Cookie: YOUR_NEW_COOKIE" \
  "https://www.futunn.com/paper-trade/common-api?_m=getAccountDetail&account_id=16992013"
```

å¦‚æœè¿”å›æ­£å¸¸æ•°æ®ï¼Œè¯´æ˜Cookieæœ‰æ•ˆã€‚

### 2. ä½¿ç”¨Pythonæµ‹è¯•

```python
import httpx
import asyncio

async def test_cookie():
    cookie = "YOUR_NEW_COOKIE"
    headers = {
        "Cookie": cookie,
        "User-Agent": "Mozilla/5.0...",
        "Referer": "https://www.futunn.com/paper-trade"
    }
    
    async with httpx.AsyncClient() as client:
        response = await client.get(
            "https://www.futunn.com/paper-trade/common-api",
            params={"_m": "getAccountDetail", "account_id": "16992013"},
            headers=headers
        )
        print(response.json())

asyncio.run(test_cookie())
```

---

## ğŸ“ æ€»ç»“

### é—®é¢˜æ ¹æº
- âœ… ä»£ç é€»è¾‘æ­£ç¡®
- âœ… APIè°ƒç”¨æ–¹å¼æ­£ç¡®
- âŒ Cookieå¯èƒ½å·²è¿‡æœŸæˆ–ä¼šè¯å¤±æ•ˆ

### è§£å†³æ–¹å‘
1. **çŸ­æœŸ**: æ›´æ–°Cookieï¼Œå®Œå–„è¯·æ±‚å¤´
2. **é•¿æœŸ**: åˆ‡æ¢åˆ°å¯Œé€”OpenD API

### å»ºè®®
**ä¼˜å…ˆå°è¯•æ›´æ–°Cookie**ï¼Œè¿™æ˜¯æœ€å¿«çš„è§£å†³æ–¹æ¡ˆã€‚å¦‚æœé—®é¢˜æŒç»­å­˜åœ¨ï¼Œå»ºè®®åˆ‡æ¢åˆ°OpenD APIä»¥è·å¾—é•¿æœŸç¨³å®šçš„æœåŠ¡ã€‚

---

**æ–‡æ¡£æ›´æ–°æ—¶é—´**: 2025-11-01 22:15  
**é—®é¢˜çŠ¶æ€**: å·²å®šä½  
**è§£å†³æ–¹æ¡ˆ**: æ›´æ–°Cookieæˆ–ä½¿ç”¨OpenD API
