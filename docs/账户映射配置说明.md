# 账户映射配置说明

## 🎯 功能概述

系统会在启动时**自动获取所有账户**，并根据配置规则建立**市场类型到账户的映射关系**。

## 📊 工作流程

```
启动服务
    ↓
自动获取所有账户
    ↓
按市场类型分组
    ↓
应用选择规则
    ↓
建立映射关系
    ↓
缓存映射结果
```

## 🔧 配置规则

在 `config.py` 中的 `ACCOUNT_SELECTION_RULES` 配置：

```python
ACCOUNT_SELECTION_RULES = {
    "prefer_non_competition": True,  # 优先选择非比赛账户
    "exclude_keywords": ["比赛", "大赛", "competition"],  # 排除关键词
}
```

### 规则说明

1. **prefer_non_competition**: 
   - `True`: 优先选择非比赛账户（模拟账户）
   - `False`: 不区分账户类型，选择第一个

2. **exclude_keywords**: 
   - 包含这些关键词的账户会被视为"比赛账户"
   - 在有其他选择时，会优先选择不包含这些关键词的账户

### 选择逻辑

当同一市场有多个账户时：

```python
if prefer_non_competition:
    # 1. 优先选择非比赛账户
    non_competition_accounts = [账户 for 账户 in 账户列表 
                                if 账户名称不包含排除关键词]
    
    if non_competition_accounts:
        return non_competition_accounts[0]  # 返回第一个非比赛账户
    else:
        return 账户列表[0]  # 如果都是比赛账户，返回第一个
else:
    return 账户列表[0]  # 不区分类型，直接返回第一个
```

## 📋 你的账户配置

根据当前登录账户，系统检测到以下账户：

### 港股账户
- **账户ID**: 9393
- **账户名称**: 港股模拟账户
- **市场类型**: HK
- **币种**: HKD
- **资产**: 699,740.53 港币

### 美股账户（模拟）
- **账户ID**: 11587526
- **账户名称**: 美股融资融券模拟账户
- **市场类型**: US
- **币种**: USD
- **资产**: 1,000,000.00 美元
- **状态**: ✅ 已选为美股默认账户

### 美股账户（比赛）
- **账户ID**: 16992013
- **账户名称**: 第二届全球模拟交易大赛
- **市场类型**: US
- **币种**: USD
- **资产**: 100,303.41 美元
- **状态**: ⚪ 未选择（因为有模拟账户）

## 🗺️ 当前映射关系

```
HK (港股) → 9393 (港股模拟账户)
US (美股) → 11587526 (美股融资融券模拟账户)
```

**说明**: 
- 港股只有一个账户，直接映射
- 美股有2个账户，系统优先选择了模拟账户（11587526）而非比赛账户（16992013）

## 🔍 查看映射关系

### 方式1: API接口

```bash
# 查看所有账户
curl http://localhost:8000/api/accounts

# 查看账户映射
curl http://localhost:8000/api/accounts/mapping
```

### 方式2: 启动日志

启动服务时会在控制台输出：

```
✅ 已加载 3 个账户:
   HK  | 9393       | 港股模拟账户
   US  | 11587526   | 美股融资融券模拟账户
   US  | 16992013   | 第二届全球模拟交易大赛

📊 市场账户映射:
   HK -> 9393 (港股模拟账户)
   US -> 11587526 (美股融资融券模拟账户)
```

### 方式3: 测试脚本

```bash
python test_account_mapping.py
```

## 🎮 使用方式

### 自动匹配（推荐）

系统会根据市场类型自动选择账户：

```bash
# 买入美股 - 自动使用 11587526 (模拟账户)
curl -X POST "http://localhost:8000/api/trade/buy?stock_code=NVDA&market_type=US&quantity=10&price=202.50"

# 买入港股 - 自动使用 9393
curl -X POST "http://localhost:8000/api/trade/buy?stock_code=00700&market_type=HK&quantity=100&price=380.00"

# 查询美股账户 - 自动使用 11587526
curl "http://localhost:8000/api/account/info?market_type=US"

# 查询港股持仓 - 自动使用 9393
curl "http://localhost:8000/api/positions?market_type=HK"
```

### 手动指定账户

如果你想使用特定账户（比如比赛账户）：

```bash
# 使用比赛账户查询
curl "http://localhost:8000/api/account/info?account_id=16992013"

# 使用比赛账户交易（需要修改API，当前版本不支持）
# 建议: 使用自动匹配，如需使用比赛账户，可修改配置规则
```

## ⚙️ 修改映射规则

### 场景1: 想使用比赛账户作为美股默认账户

修改 `config.py`:

```python
ACCOUNT_SELECTION_RULES = {
    "prefer_non_competition": False,  # 改为 False
    "exclude_keywords": [],  # 清空排除关键词
}
```

重启服务后，系统会选择第一个美股账户（可能是比赛账户）。

### 场景2: 添加更多排除关键词

```python
ACCOUNT_SELECTION_RULES = {
    "prefer_non_competition": True,
    "exclude_keywords": ["比赛", "大赛", "competition", "contest", "tournament"],
}
```

### 场景3: 手动指定映射（高级）

如果你想完全控制映射关系，可以在 `futu_client.py` 的 `_initialize_accounts` 方法中硬编码：

```python
# 在建立映射后，手动覆盖
self._account_cache = {
    "HK": "9393",
    "US": "16992013",  # 强制使用比赛账户
}
```

**注意**: 不推荐这种方式，因为会失去灵活性。

## 🧪 测试验证

### 1. 启动服务

```bash
cd futu-paper-trade-api
python main.py
```

查看启动日志，确认账户映射是否正确。

### 2. 运行测试

```bash
python test_account_mapping.py
```

测试会验证：
- 账户列表获取
- 映射关系正确性
- 规则应用是否符合预期
- 按市场类型查询是否使用正确账户

### 3. 手动验证

```bash
# 查看映射
curl http://localhost:8000/api/accounts/mapping

# 查询美股账户（应该返回 11587526）
curl "http://localhost:8000/api/account/info?market_type=US"

# 查询港股账户（应该返回 9393）
curl "http://localhost:8000/api/account/info?market_type=HK"
```

## 💡 最佳实践

1. **使用自动匹配**
   - 推荐使用 `market_type` 参数
   - 让系统自动选择合适的账户
   - 避免硬编码账户ID

2. **配置规则**
   - 根据实际需求调整 `ACCOUNT_SELECTION_RULES`
   - 修改后重启服务生效
   - 通过测试脚本验证规则

3. **监控映射**
   - 定期查看 `/api/accounts/mapping` 确认映射正确
   - 新开通账户后重启服务刷新映射
   - 注意启动日志中的映射信息

4. **特殊需求**
   - 如需使用特定账户，可临时指定 `account_id`
   - 如需永久改变映射，修改配置规则
   - 避免在代码中硬编码账户ID

## ⚠️ 注意事项

1. **账户变化**
   - 新开通账户需要重启服务
   - 账户关闭后映射会失效
   - 定期检查映射是否正确

2. **规则优先级**
   - 配置规则优先于默认行为
   - 手动指定 `account_id` 优先于自动匹配
   - 确保规则符合实际需求

3. **多账户场景**
   - 同一市场多个账户时，只会选择一个
   - 其他账户不会被使用（除非手动指定）
   - 如需切换账户，修改规则或手动指定

## 📚 相关文档

- `config.py` - 配置规则定义
- `futu_client.py` - 账户映射实现
- `test_account_mapping.py` - 测试脚本
- `更新说明.md` - 功能更新说明

## 🎉 总结

账户映射功能让你可以：
- ✅ 自动管理多个账户
- ✅ 智能选择合适的账户
- ✅ 灵活配置选择规则
- ✅ 避免账户混淆错误
- ✅ 简化API调用

现在你可以放心地进行多市场交易，系统会自动为你选择正确的账户！🚀
