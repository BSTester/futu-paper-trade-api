# 富途模拟交易账户配置完成说明

## 已完成的工作

### 1. 获取各市场账户ID

通过访问 https://www.futunn.com/paper-trade 并切换不同市场，成功获取了以下账户ID：

- **港股账户ID**: 9393
- **美股模拟账户ID**: 11587526
- **A股账户ID**: 3182575
- **美股比赛账户ID**: 3182575

### 2. 更新环境变量配置

已更新 `.env` 和 `.env.example` 文件，配置了所有市场的账户ID：

```env
# 港股账户ID
ACCOUNT_ID_HK=9393

# 美股模拟账户ID
ACCOUNT_ID_US=11587526

# A股账户ID
ACCOUNT_ID_CN=3182575

# 美股比赛账户ID（可选，如果配置则优先使用比赛账户）
ACCOUNT_ID_US_COMPETITION=3182575

# 默认账户ID（当无法匹配市场时使用）
ACCOUNT_ID=11587526
```

### 3. 代码优化

#### 移除默认账户依赖
- 修改了 `FutuClient` 类，移除了 `default_account_id` 参数
- 所有账户操作现在必须明确指定 `market_type` 参数
- 如果未配置对应市场的账户，会抛出明确的错误提示

#### 账户自动匹配
系统会根据股票代码的市场类型，自动使用对应的账户进行交易：
- 美股代码（如 AAPL, NVDA）→ 使用美股账户
- 港股代码（如 00700, 09988）→ 使用港股账户
- A股代码（如 600519, 000001）→ 使用A股账户

### 4. 真实买卖价格接口

通过浏览器网络监控，发现了获取真实买卖价格的API接口：

```
GET /paper-trade/common-api?_m=getRiskTradeAmount
参数:
- account_id: 账户ID
- order_info: JSON格式的订单信息
  {
    "price": "202.490",
    "quantity": 1,
    "side": "B",  // B=买入, S=卖出
    "order_type": 1,  // 1=限价单, 2=市价单
    "security_id": "202597",
    "security_type": 1  // 1=股票
  }
```

这个接口返回的数据包含：
- 实际成交价格
- 可用资金
- 最大可买数量
- 风险提示等信息

## 使用说明

### 1. 配置环境变量

确保 `.env` 文件中已配置所有需要的账户ID。

### 2. 下单示例

```python
from futu_client import FutuClient
from models import TradeRequest

client = FutuClient()

# 美股买入（自动使用美股账户）
trade_request = TradeRequest(
    stock_code="AAPL",
    side="BUY",
    quantity=1,
    price=None,  # 市价单
    order_type="MARKET",
    market_type="US",  # 指定市场类型
    security_type="STOCK"
)

result = await client.place_order(trade_request)
```

### 3. 查询账户信息

```python
# 查询美股账户
account_info = await client.get_account_info(market_type="US")

# 查询港股持仓
positions = await client.get_positions(market_type="HK")
```

## 注意事项

1. **必须指定市场类型**: 所有账户操作都必须提供 `market_type` 参数
2. **账户配置检查**: 如果未配置某个市场的账户，系统会返回明确的错误提示
3. **Cookie有效期**: 需要定期更新 `FUTU_COOKIE`，建议每次使用前从浏览器获取最新的Cookie
4. **市场类型映射**:
   - US: 美股
   - HK: 港股
   - CN: A股（沪深）
   - JP: 日股

## 下一步建议

1. **实现获取真实价格接口**: 添加 `get_real_trade_price()` 方法，调用 `getRiskTradeAmount` 接口
2. **添加价格验证**: 在下单前验证价格是否合理
3. **增加错误处理**: 针对不同的错误情况提供更详细的提示
4. **添加日志记录**: 记录所有交易操作，便于追踪和调试

## API接口总结

### 主要接口

1. **获取账户列表**: `GET /paper-trade/common-api?_m=getAccountList`
2. **获取账户详情**: `GET /paper-trade/common-api?_m=getAccountDetail&account_id={id}`
3. **获取持仓列表**: `GET /paper-trade/common-api?_m=getIntegratedPosList&account_id={id}`
4. **搜索股票**: `GET /search-stock/search?keyword={keyword}`
5. **获取行情**: `GET /paper-trade/common-api?_m=batchGetSecurityQuote`
6. **获取真实价格**: `GET /paper-trade/common-api?_m=getRiskTradeAmount`
7. **下单**: `POST /paper-trade/common-api?_m=placeOrder&account_id={id}`

### 订单参数

```json
{
  "price": "202.49",      // 价格
  "quantity": 1,          // 数量
  "side": "B",            // B=买入, S=卖出
  "order_type": 1,        // 1=限价单, 2=市价单
  "security_id": "78449", // 证券ID
  "security_type": 1      // 1=股票, 2=ETF, 3=期权
}
```

## 完成状态

✅ 获取所有市场账户ID
✅ 更新环境变量配置
✅ 修改代码移除默认账户
✅ 实现账户自动匹配
✅ 发现真实价格接口
⏳ 实现真实价格接口（待完成）
⏳ 完整的下单测试（待完成）
