# API更新说明 - 2025-11-03

## 概述

本次更新为技术分析接口和K线数据接口添加了日期范围过滤功能，并为周K线设置了默认的时间范围限制。

## 更新内容

### 1. 新增参数

为以下两个接口添加了可选的日期范围参数：

- `/api/technical-analysis` - 技术分析接口
- `/api/kline` - K线数据接口

**新增参数**：
- `start_date` (可选): 开始日期
- `end_date` (可选): 结束日期

**支持的日期格式**：
- `YYYY-MM-DD` (如: 2025-01-01)
- `YYYY-MM-DD HH:MM:SS` (如: 2025-01-01 09:30:00)

### 2. 周K线默认限制

为了优化性能和减少数据传输量，**周K线（interval=weekly）在不指定日期范围时，默认只返回最近1个月的数据**。

**影响的接口**：
- `/api/technical-analysis?interval=weekly`
- `/api/kline?interval=weekly`

**其他时间间隔不受影响**：
- 分钟级 (1min, 5min, 15min, 30min, 60min)
- 日K线 (daily)
- 月K线 (monthly)
- 季K线 (quarterly)
- 年K线 (yearly)

## 使用示例

### 技术分析接口

#### 不指定日期范围（返回所有数据）
```bash
curl "http://localhost:8000/api/technical-analysis?symbol=AAPL&interval=daily&indicator=macd"
```

#### 周K线不指定日期（默认最近1个月）
```bash
curl "http://localhost:8000/api/technical-analysis?symbol=AAPL&interval=weekly&indicator=macd"
```

#### 指定日期范围
```bash
# 指定完整日期范围
curl "http://localhost:8000/api/technical-analysis?symbol=AAPL&interval=daily&indicator=macd&start_date=2025-10-01&end_date=2025-10-31"

# 只指定开始日期
curl "http://localhost:8000/api/technical-analysis?symbol=AAPL&interval=daily&indicator=rsi&start_date=2025-10-15"

# 分钟级数据指定时间范围
curl "http://localhost:8000/api/technical-analysis?symbol=AAPL&interval=5min&indicator=macd&start_date=2025-11-01 09:30:00&end_date=2025-11-01 16:00:00"
```

### K线数据接口

#### 不指定日期范围（返回所有数据）
```bash
curl "http://localhost:8000/api/kline?symbol=AAPL&interval=daily"
```

#### 周K线不指定日期（默认最近1个月）
```bash
curl "http://localhost:8000/api/kline?symbol=AAPL&interval=weekly"
```

#### 指定日期范围
```bash
# 指定完整日期范围
curl "http://localhost:8000/api/kline?symbol=AAPL&interval=daily&start_date=2025-10-01&end_date=2025-10-31"

# 只指定开始日期
curl "http://localhost:8000/api/kline?symbol=AAPL&interval=daily&start_date=2025-10-15"

# 分钟级数据指定时间范围
curl "http://localhost:8000/api/kline?symbol=AAPL&interval=5min&start_date=2025-11-01 09:30:00&end_date=2025-11-01 16:00:00"
```

## 响应格式变化

当指定日期范围时，响应的 `meta` 部分会包含额外的字段：

```json
{
  "meta": {
    "symbol": "AAPL",
    "stock_name": "苹果",
    "interval": "daily",
    "data_points": 22,
    "requested_start_date": "2025-10-01",
    "requested_end_date": "2025-10-31"
  },
  "data": {...}
}
```

**新增字段**：
- `requested_start_date`: 用户请求的开始日期（如果指定）
- `requested_end_date`: 用户请求的结束日期（如果指定）

## 向后兼容性

### 完全兼容的场景

以下场景不受影响，保持原有行为：

1. **日K线及其他时间间隔**（除周K线外）
   ```bash
   # 这些请求的行为完全不变
   curl "http://localhost:8000/api/kline?symbol=AAPL&interval=daily"
   curl "http://localhost:8000/api/kline?symbol=AAPL&interval=monthly"
   curl "http://localhost:8000/api/technical-analysis?symbol=AAPL&interval=daily&indicator=macd"
   ```

2. **明确指定日期范围的请求**
   ```bash
   # 这些请求的行为完全不变
   curl "http://localhost:8000/api/kline?symbol=AAPL&interval=weekly&start_date=2025-01-01"
   ```

### 需要注意的场景

**周K线不指定日期范围**：

之前的行为：
```bash
# 之前：返回所有可用的周K线数据（可能数年）
curl "http://localhost:8000/api/kline?symbol=AAPL&interval=weekly"
```

现在的行为：
```bash
# 现在：默认只返回最近1个月的周K线数据
curl "http://localhost:8000/api/kline?symbol=AAPL&interval=weekly"
```

如果需要更长的历史数据，请明确指定：
```bash
# 获取全年的周K线数据
curl "http://localhost:8000/api/kline?symbol=AAPL&interval=weekly&start_date=2025-01-01"
```

## 迁移指南

### 如果你的代码依赖周K线的所有历史数据

**之前的代码**：
```python
import requests

# 获取周K线数据（之前返回所有历史数据）
response = requests.get(
    "http://localhost:8000/api/kline",
    params={"symbol": "AAPL", "interval": "weekly"}
)
```

**更新后的代码**：
```python
import requests

# 明确指定需要的日期范围
response = requests.get(
    "http://localhost:8000/api/kline",
    params={
        "symbol": "AAPL",
        "interval": "weekly",
        "start_date": "2025-01-01"  # 明确指定开始日期
    }
)
```

### 如果你只需要最近的数据

无需修改代码，新的默认行为更符合需求：

```python
import requests

# 获取最近1个月的周K线数据（新的默认行为）
response = requests.get(
    "http://localhost:8000/api/kline",
    params={"symbol": "AAPL", "interval": "weekly"}
)
```

## 错误处理

### 无效的日期格式

请求：
```bash
curl "http://localhost:8000/api/kline?symbol=AAPL&start_date=2025/10/01"
```

响应（HTTP 400）：
```json
{
  "detail": "无效的开始日期格式: 2025/10/01，请使用 YYYY-MM-DD 或 YYYY-MM-DD HH:MM:SS"
}
```

### 日期范围内无数据

如果指定的日期范围内没有数据，会返回空的数据数组：

```json
{
  "meta": {
    "symbol": "AAPL",
    "data_points": 0,
    "requested_start_date": "2020-01-01",
    "requested_end_date": "2020-01-31"
  },
  "data": []
}
```

## 性能优化

### 减少数据传输

通过指定日期范围，可以显著减少数据传输量：

```bash
# 只获取最近30天的数据，而不是全部历史数据
curl "http://localhost:8000/api/kline?symbol=AAPL&interval=daily&start_date=2025-10-04"
```

### 周K线默认限制的好处

1. **更快的响应时间**：减少数据处理和传输时间
2. **降低服务器负载**：减少不必要的数据查询和计算
3. **更好的用户体验**：大多数场景只需要近期数据

## 测试

### 运行测试脚本

```bash
# 测试技术分析接口
cd futu-paper-trade-api
python test_date_range.py

# 测试K线数据接口
python test_kline_date_range.py
```

### 手动测试

```bash
# 启动API服务
python main.py

# 在另一个终端测试
curl "http://localhost:8000/api/kline?symbol=AAPL&interval=weekly"
curl "http://localhost:8000/api/kline?symbol=AAPL&interval=weekly&start_date=2025-01-01"
curl "http://localhost:8000/api/technical-analysis?symbol=AAPL&interval=weekly&indicator=macd"
```

## 相关文档

- [DATE_RANGE_FEATURE.md](./DATE_RANGE_FEATURE.md) - 日期范围功能详细说明
- [WEEKLY_DEFAULT_RANGE.md](./WEEKLY_DEFAULT_RANGE.md) - 周K线默认限制说明
- [API_REFERENCE.md](./API_REFERENCE.md) - API参考文档

## 技术实现

### 代码位置

- `futu-paper-trade-api/main.py` - API端点实现
- `futu-paper-trade-api/futu_client.py` - 客户端逻辑

### 关键实现

1. **日期解析**：支持两种格式的日期输入
2. **时间戳过滤**：在数据处理阶段过滤日期范围
3. **默认值设置**：周K线自动设置默认日期范围
4. **元数据记录**：在响应中记录请求的日期范围

## 常见问题

### Q1: 为什么只有周K线有默认限制？

A: 周K线数据跨度大，不限制可能返回数年的数据，影响性能。其他时间间隔（如日K线）的数据量相对可控。

### Q2: 如何获取周K线的所有历史数据？

A: 明确指定开始日期即可：
```bash
curl "http://localhost:8000/api/kline?symbol=AAPL&interval=weekly&start_date=2020-01-01"
```

### Q3: 日期范围是否支持跨年查询？

A: 是的，完全支持：
```bash
curl "http://localhost:8000/api/kline?symbol=AAPL&interval=daily&start_date=2024-01-01&end_date=2025-12-31"
```

### Q4: 分钟级数据可以指定日期范围吗？

A: 可以，支持精确到秒的时间范围：
```bash
curl "http://localhost:8000/api/kline?symbol=AAPL&interval=5min&start_date=2025-11-01 09:30:00&end_date=2025-11-01 16:00:00"
```

### Q5: 如果只指定开始日期会怎样？

A: 会返回从开始日期到最新数据的所有数据：
```bash
curl "http://localhost:8000/api/kline?symbol=AAPL&interval=daily&start_date=2025-10-01"
```

## 总结

本次更新提供了更灵活的数据查询方式，同时通过周K线的默认限制优化了性能。对于大多数使用场景，这些改进是透明的且向后兼容的。如果你的代码依赖周K线的所有历史数据，只需要明确指定日期范围即可。
